{"ast":null,"code":"import _objectSpread from\"C:/Floki/web-hotel/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useEffect,useMemo,useState}from'react';import{HotelAPI,formatCurrency}from'../api';import{jsxs as _jsxs,jsx as _jsx,Fragment as _Fragment}from\"react/jsx-runtime\";function SaleItemCard(_ref){let{item,onAdd}=_ref;const hasOffer=!!item.offerActive&&Number(item.offerPercent||0)>0;const discounted=hasOffer?Number(item.price||0)*(1-Number(item.offerPercent||0)/100):null;const priceEl=!hasOffer?/*#__PURE__*/_jsxs(\"div\",{style:{fontWeight:600,color:'#ffb300',fontSize:17},children:[\"Ksh \",Number(item.price||0).toFixed(2)]}):/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',alignItems:'center',gap:8},children:[/*#__PURE__*/_jsxs(\"div\",{style:{textDecoration:'line-through',color:'#6a708a',fontSize:15},children:[\"Ksh \",Number(item.price||0).toFixed(2)]}),/*#__PURE__*/_jsxs(\"div\",{style:{fontWeight:700,color:'#1a2236',fontSize:18},children:[\"Ksh \",Number(discounted||0).toFixed(2)]}),/*#__PURE__*/_jsxs(\"span\",{style:{background:'#ffefe0',color:'#b85600',borderRadius:999,padding:'2px 8px',fontSize:12},children:[Number(item.offerPercent||0),\"% OFF\"]})]});return/*#__PURE__*/_jsxs(\"li\",{style:{background:'#f7f7fa',borderRadius:12,padding:20,boxShadow:'0 1px 8px #0001',display:'flex',alignItems:'center',minHeight:120,flexDirection:'column',listStyle:'none',maxWidth:420,width:'100%',justifySelf:'center'},children:[item.category==='Foods'&&item.image&&/*#__PURE__*/_jsx(\"div\",{style:{width:'100%',marginBottom:10},children:/*#__PURE__*/_jsx(\"img\",{src:item.image,alt:item.name,style:{width:'100%',maxHeight:160,objectFit:'cover',borderRadius:8}})}),/*#__PURE__*/_jsx(\"div\",{style:{display:'flex',alignItems:'center',gap:8,marginBottom:8,width:'100%',justifyContent:'space-between'},children:/*#__PURE__*/_jsx(\"div\",{style:{fontWeight:700,fontSize:20},children:item.name})}),item.category==='Foods'&&/*#__PURE__*/_jsx(\"div\",{style:{color:'#555',marginBottom:6,width:'100%'},children:item.description}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',alignItems:'center',gap:10,width:'100%',justifyContent:'space-between'},children:[priceEl,/*#__PURE__*/_jsx(\"button\",{onClick:()=>onAdd(item),style:{background:'#1a2236',color:'#fff',border:'none',borderRadius:6,padding:'8px 18px',fontWeight:600,cursor:'pointer'},children:\"Add\"})]})]});}export default function MakeSalePage(){const[items,setItems]=useState([]);const[loading,setLoading]=useState(true);const[error,setError]=useState('');const[query,setQuery]=useState('');const[utensils,setUtensils]=useState([]);const[condiments,setCondiments]=useState([]);const[cart,setCart]=useState([]);const[mpesaNumber,setMpesaNumber]=useState('');const[mpesaStatus,setMpesaStatus]=useState('');const[mpesaPushed,setMpesaPushed]=useState(false);const[processing,setProcessing]=useState(false);const[paymentMode,setPaymentMode]=useState('cash');// 'cash' | 'mpesa' | 'card'\nconst[card,setCard]=useState({number:'',name:'',expiry:'',cvv:''});const[deliveryType,setDeliveryType]=useState('pickup');const[markCompleted,setMarkCompleted]=useState(false);const[creating,setCreating]=useState(false);const[msg,setMsg]=useState('');useEffect(()=>{async function load(){setLoading(true);setError('');try{const data=await HotelAPI.listMenu();setItems(data);}catch(e){setError(e.message||'Failed to load menu');}finally{setLoading(false);}}load();},[]);useEffect(()=>{fetch('/api/hotel/config').then(res=>res.ok?res.json():Promise.resolve({utensils:[],condiments:[]})).then(cfg=>{setUtensils(Array.isArray(cfg.utensils)?cfg.utensils:[]);setCondiments(Array.isArray(cfg.condiments)?cfg.condiments:[]);}).catch(()=>{});},[]);function addToCart(item){setCart(prev=>{const idx=prev.findIndex(ci=>ci._id===item._id);if(idx>=0){const next=[...prev];next[idx]=_objectSpread(_objectSpread({},next[idx]),{},{qty:(next[idx].qty||1)+1});return next;}return[...prev,_objectSpread(_objectSpread({},item),{},{qty:1,selectedUtensils:[],selectedCondiments:[],notes:''})];});}function removeFromCart(id){setCart(prev=>prev.filter(ci=>ci._id!==id));}function updateCart(id,patch){setCart(prev=>prev.map(ci=>ci._id===id?_objectSpread(_objectSpread({},ci),patch):ci));}function changeQty(id,delta){setCart(prev=>prev.map(ci=>ci._id===id?_objectSpread(_objectSpread({},ci),{},{qty:Math.max(1,(ci.qty||1)+delta)}):ci));}const filteredItems=useMemo(()=>{const q=query.trim().toLowerCase();return items.filter(item=>{if(!q)return true;const fields=[item.name,item.description,item.category,item.type,String(item.price)].concat(Array.isArray(item.ingredients)?item.ingredients:[]);return fields.filter(Boolean).some(f=>String(f).toLowerCase().includes(q));});},[items,query]);function unitPrice(item){const price=Number(item.price||0);const pct=Number(item.offerPercent||0);if(!!item.offerActive&&pct>0)return price*(1-pct/100);return price;}const total=useMemo(()=>{return cart.reduce((sum,it)=>sum+unitPrice(it)*(it.qty||1),0);},[cart]);function isValidMpesaNumber(num){return /^(07\\d{8}|011\\d{7})$/.test(num);}async function handleMpesaPush(){setMsg('');setMpesaStatus('Initiating M-Pesa payment...');setProcessing(true);try{if(!isValidMpesaNumber(mpesaNumber)){throw new Error('Enter a valid Safaricom number (e.g., 07xxxxxxxx or 011xxxxxxx)');}let phone=mpesaNumber;if(phone.startsWith('0'))phone='254'+phone.slice(1);const res=await fetch('/api/mpesa/stkpush',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount:Math.round(total),phone})});const data=await res.json();if(!res.ok||data.error)throw new Error(data.error&&(data.error.message||data.error)||(data.missing?\"Missing config: \".concat(data.missing.join(', ')):'M-Pesa push failed'));setMpesaStatus('STK Push sent. Ask client to enter M-Pesa PIN.');setMpesaPushed(true);setProcessing(false);}catch(err){setMpesaStatus('');setMsg('M-Pesa error: '+err.message);setProcessing(false);setTimeout(()=>setMsg(''),3000);}}async function createSale(){if(cart.length===0){setMsg('Add at least one item');setTimeout(()=>setMsg(''),2500);return;}if(paymentMode==='mpesa'){if(!isValidMpesaNumber(mpesaNumber)){setMsg('Enter a valid M-Pesa number');setTimeout(()=>setMsg(''),2500);return;}if(!mpesaPushed){setMsg('Push STK first before creating the sale');setTimeout(()=>setMsg(''),2500);return;}}if(paymentMode==='card'){const numOk=/^\\d{12,19}$/.test(card.number.replace(/\\s+/g,''));const nameOk=!!card.name.trim();const expOk=/^\\d{2}\\/\\d{2}$/.test(card.expiry.trim());const cvvOk=/^\\d{3,4}$/.test(card.cvv.trim());if(!numOk||!nameOk||!expOk||!cvvOk){setMsg('Enter valid card details');setTimeout(()=>setMsg(''),2500);return;}}const confirmText=\"Confirm Create Sale for \".concat(formatCurrency(Number(total.toFixed(2))),\"?\");if(!window.confirm(confirmText)){return;}setCreating(true);setMsg('');try{let staffDisplayName=null;try{staffDisplayName=typeof localStorage!=='undefined'?localStorage.getItem('staffDisplayName'):null;}catch(_unused){}const payload={clientPhone:paymentMode==='mpesa'&&mpesaNumber?'+254'+mpesaNumber.slice(1):undefined,servedByName:staffDisplayName||undefined,saleType:'Over the Counter',status:'completed',items:cart.map(ci=>({menuItem:ci._id,quantity:ci.qty||1,utensils:ci.selectedUtensils||[],condiments:ci.selectedCondiments||[],notes:ci.notes||undefined})),total:Number(total.toFixed(2)),paymentStatus:paymentMode==='cash'||paymentMode==='card'?'paid':'pending'};const order=await HotelAPI.createOrder(payload);if(markCompleted&&order&&order._id){await HotelAPI.updateOrder(order._id,{status:'completed',servedByName:staffDisplayName||undefined});}setCart([]);setMpesaNumber('');setMpesaStatus('');setMpesaPushed(false);setPaymentMode('cash');setCard({number:'',name:'',expiry:'',cvv:''});setMsg('Sale created');setTimeout(()=>setMsg(''),2500);}catch(err){setMsg(err.message||'Failed to create sale');setTimeout(()=>setMsg(''),3000);}finally{setCreating(false);}}return/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',alignItems:'center',gap:12,marginBottom:12},children:[/*#__PURE__*/_jsx(\"h2\",{style:{margin:0,color:'#1a2236'},children:\"Make a Sale\"}),/*#__PURE__*/_jsx(\"div\",{style:{marginLeft:'auto',display:'flex',gap:8,alignItems:'center'},children:/*#__PURE__*/_jsx(\"input\",{type:\"search\",placeholder:\"Search\\u2026\",value:query,onChange:e=>setQuery(e.target.value),style:{padding:'8px 12px',borderRadius:8,border:'1px solid #e1e4ee',minWidth:220}})})]}),loading&&/*#__PURE__*/_jsx(\"div\",{children:\"Loading\\u2026\"}),error&&/*#__PURE__*/_jsx(\"div\",{style:{color:'crimson'},children:error}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'grid',gridTemplateColumns:'2fr 1fr',gap:16},children:[/*#__PURE__*/_jsx(\"ul\",{style:{listStyle:'none',padding:0,margin:0,display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(280px, 1fr))',justifyItems:'center',gap:20,width:'100%'},children:filteredItems.map(item=>/*#__PURE__*/_jsx(SaleItemCard,{item:item,onAdd:addToCart},item._id))}),/*#__PURE__*/_jsxs(\"div\",{style:{border:'1px solid #eef0f6',borderRadius:12,padding:12,background:'#fafbfe'},children:[/*#__PURE__*/_jsx(\"div\",{style:{fontWeight:700,marginBottom:8,color:'#1a2236'},children:\"Cart\"}),cart.length===0&&/*#__PURE__*/_jsx(\"div\",{style:{color:'#6a708a'},children:\"No items yet.\"}),/*#__PURE__*/_jsx(\"ul\",{style:{listStyle:'none',padding:0,margin:0,display:'grid',gap:10},children:cart.map(ci=>/*#__PURE__*/_jsxs(\"li\",{style:{background:'#fff',borderRadius:10,boxShadow:'0 1px 6px #0001',padding:'8px 12px'},children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',alignItems:'center',gap:8},children:[/*#__PURE__*/_jsx(\"div\",{style:{fontWeight:700,color:'#1a2236',flex:1},children:ci.name}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>removeFromCart(ci._id),style:{border:'none',background:'#ffe9e6',color:'#b23b2e',borderRadius:6,padding:'6px 10px'},children:\"Remove\"})]}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',gap:8,alignItems:'center',marginTop:6},children:[/*#__PURE__*/_jsx(\"label\",{style:{color:'#6a708a'},children:\"Qty\"}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'inline-flex',alignItems:'center',gap:8},children:[/*#__PURE__*/_jsx(\"button\",{onClick:()=>changeQty(ci._id,-1),style:{width:32,height:32,borderRadius:8,border:'1px solid #e1e4ee',background:'#fff',color:'#1a2236',fontWeight:700},children:\"-\"}),/*#__PURE__*/_jsx(\"div\",{style:{minWidth:28,textAlign:'center',fontWeight:700,color:'#1a2236'},children:ci.qty}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>changeQty(ci._id,+1),style:{width:32,height:32,borderRadius:8,border:'1px solid #e1e4ee',background:'#fff',color:'#1a2236',fontWeight:700},children:\"+\"})]}),/*#__PURE__*/_jsx(\"span\",{style:{marginLeft:'auto',fontWeight:700,color:'#ffb300'},children:formatCurrency(unitPrice(ci)*(ci.qty||1))})]}),utensils.length>0&&/*#__PURE__*/_jsxs(\"div\",{style:{marginTop:8},children:[/*#__PURE__*/_jsx(\"div\",{style:{fontWeight:600,color:'#1a2236'},children:\"Utensils\"}),/*#__PURE__*/_jsx(\"div\",{style:{display:'flex',flexWrap:'wrap',gap:8,marginTop:6},children:utensils.map(u=>{const checked=(ci.selectedUtensils||[]).includes(u);return/*#__PURE__*/_jsxs(\"label\",{style:{display:'flex',alignItems:'center',gap:6,background:'#f7f7fa',border:'1px solid #e1e4ee',borderRadius:999,padding:'4px 10px'},children:[/*#__PURE__*/_jsx(\"input\",{type:\"checkbox\",checked:checked,onChange:e=>{const next=new Set(ci.selectedUtensils||[]);if(e.target.checked)next.add(u);else next.delete(u);updateCart(ci._id,{selectedUtensils:Array.from(next)});}}),/*#__PURE__*/_jsx(\"span\",{children:u})]},u);})})]}),condiments.length>0&&/*#__PURE__*/_jsxs(\"div\",{style:{marginTop:8},children:[/*#__PURE__*/_jsx(\"div\",{style:{fontWeight:600,color:'#1a2236'},children:\"Condiments\"}),/*#__PURE__*/_jsx(\"div\",{style:{display:'flex',flexWrap:'wrap',gap:8,marginTop:6},children:condiments.map(c=>{const checked=(ci.selectedCondiments||[]).includes(c);return/*#__PURE__*/_jsxs(\"label\",{style:{display:'flex',alignItems:'center',gap:6,background:'#f7f7fa',border:'1px solid #e1e4ee',borderRadius:999,padding:'4px 10px'},children:[/*#__PURE__*/_jsx(\"input\",{type:\"checkbox\",checked:checked,onChange:e=>{const next=new Set(ci.selectedCondiments||[]);if(e.target.checked)next.add(c);else next.delete(c);updateCart(ci._id,{selectedCondiments:Array.from(next)});}}),/*#__PURE__*/_jsx(\"span\",{children:c})]},c);})})]})]},ci._id))}),/*#__PURE__*/_jsxs(\"div\",{style:{marginTop:12,borderTop:'1px solid #eef0f6',paddingTop:12,display:'grid',gap:10},children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:'grid',gridTemplateColumns:'1fr',gap:10},children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',fontSize:12,color:'#6a708a'},children:\"Payment Mode\"}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',gap:12,alignItems:'center'},children:[/*#__PURE__*/_jsxs(\"label\",{style:{display:'flex',alignItems:'center',gap:6},children:[/*#__PURE__*/_jsx(\"input\",{type:\"radio\",name:\"paymode\",checked:paymentMode==='cash',onChange:()=>setPaymentMode('cash')}),\" Cash\"]}),/*#__PURE__*/_jsxs(\"label\",{style:{display:'flex',alignItems:'center',gap:6},children:[/*#__PURE__*/_jsx(\"input\",{type:\"radio\",name:\"paymode\",checked:paymentMode==='mpesa',onChange:()=>setPaymentMode('mpesa')}),\" M-Pesa\"]}),/*#__PURE__*/_jsxs(\"label\",{style:{display:'flex',alignItems:'center',gap:6},children:[/*#__PURE__*/_jsx(\"input\",{type:\"radio\",name:\"paymode\",checked:paymentMode==='card',onChange:()=>setPaymentMode('card')}),\" Card\"]})]})]}),paymentMode==='mpesa'&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:'grid',gridTemplateColumns:'1fr auto',gap:10,alignItems:'end'},children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',fontSize:12,color:'#6a708a'},children:\"M-Pesa Number\"}),/*#__PURE__*/_jsx(\"input\",{value:mpesaNumber,onChange:e=>setMpesaNumber(e.target.value),placeholder:\"07xxxxxxxx or 011xxxxxxx\",style:{width:'100%',padding:8,borderRadius:8,border:'1px solid #e1e4ee'}})]}),/*#__PURE__*/_jsx(\"button\",{onClick:handleMpesaPush,disabled:processing||total<=0,style:{background:'#ffb300',color:'#1a2236',border:'none',borderRadius:8,padding:'10px 18px',fontWeight:700},children:processing?'Pushing…':'Push STK'})]}),mpesaStatus&&/*#__PURE__*/_jsx(\"div\",{style:{color:'#6a708a'},children:mpesaStatus})]}),paymentMode==='card'&&/*#__PURE__*/_jsxs(\"div\",{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10},children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',fontSize:12,color:'#6a708a'},children:\"Card Number\"}),/*#__PURE__*/_jsx(\"input\",{value:card.number,onChange:e=>setCard(_objectSpread(_objectSpread({},card),{},{number:e.target.value})),placeholder:\"1234 5678 9012 3456\",style:{width:'100%',padding:8,borderRadius:8,border:'1px solid #e1e4ee'}})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',fontSize:12,color:'#6a708a'},children:\"Name on Card\"}),/*#__PURE__*/_jsx(\"input\",{value:card.name,onChange:e=>setCard(_objectSpread(_objectSpread({},card),{},{name:e.target.value})),placeholder:\"Full Name\",style:{width:'100%',padding:8,borderRadius:8,border:'1px solid #e1e4ee'}})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',fontSize:12,color:'#6a708a'},children:\"Expiry (MM/YY)\"}),/*#__PURE__*/_jsx(\"input\",{value:card.expiry,onChange:e=>setCard(_objectSpread(_objectSpread({},card),{},{expiry:e.target.value})),placeholder:\"MM/YY\",style:{width:'100%',padding:8,borderRadius:8,border:'1px solid #e1e4ee'}})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',fontSize:12,color:'#6a708a'},children:\"CVV\"}),/*#__PURE__*/_jsx(\"input\",{value:card.cvv,onChange:e=>setCard(_objectSpread(_objectSpread({},card),{},{cvv:e.target.value})),placeholder:\"123\",style:{width:'100%',padding:8,borderRadius:8,border:'1px solid #e1e4ee'}})]})]}),/*#__PURE__*/_jsxs(\"div\",{style:{fontWeight:800,fontSize:18,color:'#1a2236'},children:[\"Total: \",formatCurrency(total)]})]}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',gap:8},children:[/*#__PURE__*/_jsx(\"button\",{onClick:createSale,disabled:creating,style:{background:'#1a2236',color:'#fff',border:'none',borderRadius:8,padding:'10px 18px',fontWeight:700},children:creating?'Creating…':'Create Sale'}),msg&&/*#__PURE__*/_jsx(\"span\",{style:{color:msg==='Sale created'?'#1a8f3c':'crimson',fontWeight:600},children:msg})]})]})]})]})]});}","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}